Понедельник начинается в субботу или что можно узнать о жизни в другой стране из логов sci-hub

Наверное на хабре не найдётся людей, которые были бы незнакомы с scihub-ом. Sci-hub - крупнейший пиратский сайт, дающий доступ к миллионам академических статей из огромного числа научных журналов. Им пользуются почти во всём мире, поскольку доступ к статьям обходится очень дорого даже для топовых университетов. И даже когда у учёного есть доступ к журналу, скачать через сайхаб зачастую оказывается удобнее и быстрее, чем через сайт издателя. В день через sci-hub скачивается около полумиллиона статей. Что же в этом во всём привлекает меня? Ну конечно же логи!
Недавно Александра Элбакян - автор sci-hub <a href="https://vk.com/wall-36928352_20202">выложила</a> анонимизированные логи скачиваний статей за 2017 год (<a href="
sci-hub.tw/downloads/2017.statistics.tab">основная часть</a>, потерянная <a href="http://sci-hub.tw/downloads/2017.statistics.1016.j.tab">добавка</a> от Эльзивера). Для нас статистика скачиваний - это возможность посмотреть, как устроен рабочий год учёного или инженера. Вы ведь не меньше моего хотите знать, как будет устроена ваша жизнь, когда вы эмигрируете в Колумбию или Китай. Поехали!

Сразу оговорюсь, что этот анализ не претендует на полноту и глубину охвата. Чем больше я вертел данные, тем больше чувствовал себя в роли зоолога, который изучает не общие признаки разных зверюшек, а скорее их отличия. Далеко не все результаты я могу уверенно объяснить, поэтому буду отчаянно спекулировать. Так и следует относиться к этой статье - это рассказ про интересные находки, а не исчерпывающая теория устройства мира.

Мой интерес начался с изучения того как устроен рабочий день в разных странах, так что именно региональной специфике будет посвящена большая часть моего рассказа.
Чтобы читать статью было интереснее, я прятал в спойлеры самые интересные результаты. Прежде чем открывать их, попробуйте спрогнозировать результат (из соображений читабельности спрятаны не все результаты, так что крутите колёсико мышки неторопливо). И как вы можете догадаться, в статье много картинок - вы предупреждены.
<img src="http://stuff.geo-history.org/scihub_analysis/habr/img/clock-who-cares.jpeg" />
<cut/>

<h2>Что мы знаем о мировой науке</h2>
Для начала небольшой экскурс в то, что успели сделать до меня. Началось всё со <a href="http://www.sciencemag.org/news/2016/04/whos-downloading-pirated-papers-everyone">статьи</a> журналиста Джона Боханнона в Science, который попросил Александру Элбакян выдать ему логи сайхаба. Шёл 2016-й год и общественность не понимала, кто пользуется пиратским ресурсом. Вывод Боханнона для многих был неожиданным: сайхабом пользуются и в богатых, и в бедных странах. В качестве побочного эффекта статьи был опубликован <a href="https://datadryad.org//resource/doi:10.5061/dryad.q447c">датасет</a> с полугодовыми логами скачиваний. Попутно автор сайхаба отладила движок для геопривязки скачиваний - и в начале 2018-го года Александра <a href="https://vk.com/wall-36928352_20202">опубликовала</a> аналогичный лог, но уже за весь 2017-й год. За это время аудитория сайта стала только активнее, и вместо 200 тысяч скачиваний в день сайхаб обслуживает уже более 500 тысяч скачиваний в день.
После выхода статьи Боханнона появилось ещё несколько публикаций. Вот, например, он же дал <a href="https://blog.datadryad.org/2016/04/28/sci-hub-stories/">комментарий</a>, сопроводив его картой, иллюстрирующей работу сайхаба за двое суток.
Бианка Крамер <a href="https://im2punt0.wordpress.com/2016/06/20/sci-hub-utrecht-case-study-part-1/">изучила</a> географию скачиваний в Нидерландах, чтобы разобраться, почему пользуются сайхабом: оттого что у исследователей нет доступа к публикациям или потому что это удобнее. Однозначного ответа на этот вопрос пока нет.
Бастиан Цоварас также <a href="http://ruleofthirds.de/scihub-part2/">пытался</a> оценить долю пользователей в университетах. У обоих исследователей вышло, что с университетских адресов приходит порядка 9% загрузок. Помимо этого Бастиан Цоварас <a href="http://ruleofthirds.de/analyzing-scihub-data/">строил</a> корреляции с различными экономическими показателями, которые показали, что в богатых странах качают даже больше, и сделал некоторые заметки про сезонность скачиваний (но эти замечания как раз довольно сомнительного качества). 
Исследование географии пользователей по IP адресам было подвергнуто <a href="http://www.caldera-publishing.com/blog/2016/5/3/interpreting-sci-hub-data">критике</a>. Авторы заметки утверждают, что города, где много качают хорошо коррелируют с местами расположения крупных провайдеров, так как IP может разрешаться не в координаты пользователя, а в координаты провайдера. При интерпретации результатов стоит учитывать, что геокодирование IP адресов неточно. Кстати, у нас будет возможность очень ярко пронаблюдать этот эффект.

<h2>Чего мы не знаем о мировой науке</h2>
<h4>И откуда мы не знаем то, чего не знаем</h4>
Вернёмся к нашим <s>бандер</s>логам и разберемся, какая информация у нас в распоряжении. Нам доступен doi-идентификатор статьи (это такая специальная перманентная ссылка), серверное время, географические координаты, страна с городом. ip и идентификатор пользователя в целях анонимизации пользователей переведены в ничего не значащие номера.
<table>
	<thead>
		<tr><th>timestamp</th><th>doi</th><th>ip</th><th>user</th><th>country</th><th>city</th><th>lat</th><th>lng</th></tr>
	</thead>
	<tbody>
		<tr><td>2017-01-01 00:00:28</td><td>10.1016/j.ajodo.2004.08.024</td><td>46</td><td>48</td><td>Egypt</td><td>N/A</td><td>30.0527614</td><td>31.3641695</td></tr>
		<tr><td>2017-02-02 21:13:37</td><td>10.1109/4.818917</td><td>1855983</td><td>2715037</td><td>Singapore</td><td>Singapore</td><td>N/A</td><td>N/A</td></tr>
		<tr><td>2017-04-16 20:25:05</td><td>10.1016/j.jsg.2005.01.014</td><td>1752366</td><td>105597</td><td>Poland</td><td>Warszawa</td><td>52.2296756</td><td>21.0122287</td></tr>	
	</tbody>
</table>

Как определяется identity пользователя можно только догадываться. Логиниться на сайте нельзя, так что вероятно, что для этого используются куки. А значит мы не можем склеить сессии пользователя в разных браузерах, в режиме инкогнито, с рабочего и домашнего компьютера итд. <!-- Об этом мы ещё поговорим отдельно. -->

Время в логах указано серверное; по косвенным признакам можно сказать, что сервер живёт в московской временной зоне (UTC+3, без перевода часов на летнее время). Нам это не подходит, мы ведь хотим узнать рабочий график людей, а не сервера. Скажем, статистика по дням недели будет некорректна без такого преобразования, ведь пока у сервера суббота, у пользователей в других странах может быть ещё пятница или уже воскресенье.
Первое, что мы сделаем - это переведём часы. Большинство стран очень удачно решили, что им хватит одной временной зоны - с ними легко. Ещё часть загрузок имеет координаты, либо хотя бы название города - их тоже легко соотнести с временной зоной. Приблизительно для 2% записей точно выявить временную зону не удалось, но нам хватит и оставшихся 190 миллионов записей.
Интересно, что такие неопознанные записи очень неравномерно распределены по году. Например, в середине года было очень много записей из неизвестного места в США, в начале и в конце года - в десятки раз меньше. Ошибка ли это геокодера или особенности работы какого-то бота/провайдера - неясно.

В процессе конвертации времени выяснилась пара неочевидных моментов. В нескольких странах (например, в Германии) формально есть две временные зоны, но на 2017-й год они совпадают. Ещё интересный факт: два года назад география сайхаба охватывала все континенты, кроме Антарктики, но за последний год это упущение было исправлено, что выразилось в появлении загадочной временной зоны None. Сайхабят оттуда в основном довольно печальные вещи, но бывают у тамошних обитателей и довольно неожиданные интересы, как вот эта <a href="https://doi.org/10.1108/17511061111186523">статья</a> про развитие винного туризма в Испании. Позднее этот пользователь ничего не искал, но надеюсь, у него всё хорошо.

<h4>Где живут инженеры</h4>
Главное правило дата-журналистики, как я его понимаю: "Видишь координаты - делай карту". Увы, как я писал, карту скачиваний уже сделали до меня. Но это было давно, так что, как говорится, можем повторить. К сожалению, нам потребуется сразу две карты-хороплета: <spoiler title ="число скачиваний по странам"><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/choropleth_num_downloads.png" /></spoiler> и <spoiler title="десятичный логарифм числа скачиваний."><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/choropleth_log10_num_downloads.png" /></spoiler>
Иначе мы не увидим разницу либо в области малых значений (ЮАР с его 400 тысячами скачиваний будет неотличим от Намибии с 6 тысячами), либо в области высоких значений (не сможем отличить Китай от России).
Дополнительно приведу здесь карту <spoiler title="числа скачиваний на душу населения (в логарифмической шкале)"><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/choropleth_log10_num_downloads_per_capita.png" /></spoiler>
Здесь мне пришлось выкинуть страны, с очень маленьким населением и очень низким числом скачиваний - чтобы они не перекашивали цветовую шкалу.

Теперь построим чуть более детальные карты научной активности - по областям знаний. Префикс doi-идентификатора кодирует издателя, однако большая часть мировой научной периодики контролируется всего несколькими очень многопрофильными издателями: Elseiver, Springer-Nature, Wiley. Однако есть пара очень крупных издателей "узко специализированной" тематики: IEEE для инженеров-электронщиков и American Chemical Society плюс The Royal Society of Chemistry - для химиков. С химиками всё не очень интересно, а инженеры-электронщики распределены сильно неравномерно.
<spoiler title="Ваши предположения?">
Абсолютным лидером в этой области будет Индия. Хотя в целом у неё в два раза меньше закачек, чем в Китае, конкретно статей IEEE они выкачивают аж в три раза больше, чем Китай! В среднем на журналы IEEE приходится 6.5% скачиваний от общего числа, но в Индии, Южной Корее, Бангладеше и Сингапуре эта доля достигает аж 15-20%. Больше только на Сейшеллах (но где те Сейшеллы) и странах, где сайхабом почти не пользуются (там пяток активных пользователей способны сместить статистику). Может, китайцы уже выкачали всю IEEE, а индусы только в процессе? Или Индия запустила свою "лунную программу"? Надеюсь, что в комментарии придёт кто-нибудь и расскажет, чего мы не знаем об Индии и Китае, что могло бы объяснить такой странный перекос.
<img src="http://stuff.geo-history.org/scihub_analysis/habr/img/choropleth_share_ieee_downloads.png" />
</spoiler>

Откровенно говоря, исходно я рассчитывал проверить не IEEE, а Elsevier, в надежде на то, что увижу всплеск скачиваний в Германии, где 60 университетов <a href="https://www.nature.com/news/german-scientists-regain-access-to-elsevier-journals-1.21482">отказались от подписки</a> на журналы гиганта издательского бизнеса. Но карты демонстрируют совершенно иную картину: доля Эльзивера в среднем 30%, в Германии на пару процентов меньше. А лидеры - Марокко, Алжир, Боливия, Тунис и Перу - аж 50% статей <spoiler title="качают с Эльзивера."><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/choropleth_share_elsevier_downloads.png" /></spoiler>
Позднее мне стало понятно, что Elsevier восстановил университетам доступ, несмотря на отсутствие соглашения. Чтобы проанализировать эффект, я посмотрел, на первые 40 дней года, когда длился бан, но картина практически не изменилась.

Ещё одним интересным открытием для меня была серьезная популярность (несколько процентов всех скачиваний) статей с префиксом <code>10.1111/</code>, принадлежащим довольно экзотическому издателю: The Korean Society of Plant Taxonomists. Как думаете, почему? <spoiler title="Разгадка">В действительности doi-префикс не однозначно кодирует издателя. Хотя зона <code>10.1111/</code> раньше и принадлежала корейским ботаникам, сейчас она перешла под контроль Wiley.</spoiler>

<h4>"Восемьдесят три процента всех дней в году начинаются одинаково: звенит будильник".</h4>
Как я упоминал, <a href="http://ruleofthirds.de/analyzing-scihub-data/">попытка</a> изучить временной профиль использования сайхаба уже предпринималась, но... сделано это было для галочки: рассматривались только две страны, с низким разрешением и некорректной аттрибуцией дня недели. А главное и наиболее возмутительное - это интерпретация. Два совершенно непохожих графика: для Германии и для Гонг-Конга названы одинаковыми. Мол, видно, что работают с 9 до 17. В действительности в разных странах профили использования сайхаба на протяжении дня отличаются разительно! 
Мы скоро будем строить свои, правильные графики, но прежде я расскажу вам, как они устроены и почему именно так.

<h4>Тактика наезда-отката</h4>
Чтобы изучить, как работают пользователи в разных странах, мы будем строить графики числа скачиваний за определенный временной промежуток. Данных достаточно много, но нам всё же придётся балансировать между детализацией и чёткостью картины - ведь для того чтобы что-то увидеть, статистика должна стабилизироваться. Изначально я строил график числа скачиваний в каждый час дня, просуммированный по всем дням года. Уже из таких графиков стало понятно, что история вырисовывается крайне интересная.
Параллельно я построил графики числа скачиваний по дням недели, но они получались не слишком внятные (и некрасивые: всего семь точек). Однако оказалось, что если совместить эти графики и считать скачивания в полдень понедельника и в полдень воскресенья по-отдельности картина, выглядит более чем занятно, а статистики на них более-менее хватает. Увеличив разрешение до 10 минут мы видим больше деталей, а шум всё ещё на приемлемом уровне. Оставляем!
Чтобы графики были сравнимы между разными городами и странами, они отнормированы на максимум. Нормировать на суммарное число скачиваний не очень удобно: понижение доли скачиваний в одном месте ведёт к росту доли в другом. Из-за этого может возникнуть иллюзия, что в какой-то одной стране работают гораздо более напряженно, чем в другой. На самом же деле мы не можем корректно сравнить абсолютный уровень работы двух стран между собой, и сравниваем лишь относительный уровень работы внутри одной страны в разное время суток.

Параллельно я пытался изучить, как устроен не день, а год. Например, строил график числа скачиваний в каждый из 365 дней года. Он получался уж совсем никакой. Во-первых, шумный, но это решается медианным сглаживанием с окном в неделю. А во-вторых, его было очень тяжело интерпретировать, и это исправить уже сложнее.
Чтобы построить другой график, я ввёл такую характеристику как "центр масс дня" - это усреднение времени, когда произошло скачивание (альтернативный подход - медианный момент скачивания). Идея была в том, чтобы вычислить одну характеристику, по которой можно было бы узнать, насколько рано начинается и заканчивается рабочий день в разные времена года. Однако оказалось, что я не умею описать этот график в одно предложение - верный признак того, что его никто не поймёт. Сложность описания и интерпретации побудила меня искать другие способы визуализации.

Оказалось, что мы снова можем скрестить графики и построить тепловую карту, на которой по одной оси будет отложено время относительно начала недели, а по другой оси будут сменяться недели года. На такой карте, как ни странно, остаются видны закономерности недельного графика (хотя читать их всё ещё проще по графику средней недели), но гораздо важнее, что становятся видны артефакты.
Мы можем на тепловой карте откладывать, например каждый час года как одну точку. Чтобы повысить чёткость картины можем ввести дополнительный уровень агрегирования. Я использовал такой вариант: взять все десятиминутки дня и просуммировать их по всем семи дням внутри конкретной недели. Тогда получается взглянуть на различия между неделями года в форме тепловой карты.
Нам придётся время от времени делать zoom out/zoom in, чтобы издалека увидеть эффекты, а потом, приблизившись, их объяснить.
С тепловыми картами меня ждала ещё одна сложность: не были видны детали, либо в зоне слабой интенсивности, либо в зоне активной работы. Когда мы строили карты, пришлось строить сразу две карты: в обычной и логарифмической шкале. Но тепловых карт и так будет много, удваивать их число показалось мне плохой идеей. К счастью, оказалось, что при помощи <a href="https://github.com/bokeh/colorcet">однородно-воспринимаемой цветовой палитры</a> можно решить проблему. С картами, впрочем, этот фокус не прокатил.

<h4>Верить нельзя никому. Мне - можно.</h4>
Наконец, последняя пара замечаний, прежде чем перейти к картинкам - про то, насколько этим картинкам стоит верить 

Следует держать в голове, что в логах отсутствует приблизительно месяц наблюдений, разбитый на два-три крупных интервала: 21-29 апреля, 7-29 октября, плюс одиночные сбои и блокировки сайхаба в отдельных странах. На тепловых картах вы увидите полосы в дни блокировок.
кроме того лог начинается и кончается в 2017 году по серверному времени. По местному времени эти сбои приходились на разные интервалы дня/недели поэтому какие-то части графика может потребоваться немного корректировать (и ещё хуже обстоит дело со странами, расположившимися в нескольких временных зонах). Давайте оценим периоды (не)доступности сервера, чтобы оценить масштаб ошибки и определить, стоит ли нам заморачиваться коррекцией. Разобьем каждую неделю на 10-минутные интервалы (в едином часовом поясе, например, UTC) и оценим доступность сервера так: число таких интервалов в году, когда сервер был доступен, деленное на общее число таких интервалов. Получается, что доступность сервера колеблется от 86% до 92%, т.е. разница около 6.5%. Это ошибка на отношение долей скачивания в разное время недели. При том уровне шума, который наблюдается в данных, ошибка на 6.5% не должна всерьез нас волновать.
Здесь не учтены локальные блокировки. Я отдельно посчитал, что выходит в России (где sci-hub был заблокирован с 6 по 9 сентября) - ошибка увеличивается до 9.5%. На конец пятницы-субботу (в UTC) выпало немного больше сбоев, чем на другие дни. Можете в уме на 5-10% процентов увеличивать число скачиваний в субботу и её окрестности, но общую картину это практически не изменит.
Вероятно также, что в средний распорядок дня дают вклад праздники. Если праздники смещаются на пятницу - это тоже может повлиять на наблюдаемую картину.

Про ошибки геокодирования я уже говорил, но они тоже едва ли дают серьезный вклад. А вот боты могут обернуться настоящей головной болью. Я не взялся очистить данные от ботов, эта задача ещё ждёт своего исследователя. Просто учитывайте, что где-то в фоновом режиме они работают. Скорее всего это те самые ребята, которые никогда не спят: вряд ли боты ведут себя настолько умно, чтобы имитировать человека, так что, когда их становится много, это сложно не заметить.

<h2>"Трудовое законодательство нарушалось злостно и повсеместно"</h2>
Ок, давайте наконец посмотрим, как же распределены рабочие часы в разных странах. Для начала мы, конечно, посмотрим на дефолт-сити, город-герой Москву с её 2.4M скачиваний. <spoiler title="Угадали, как он выглядит?">
<img src="http://stuff.geo-history.org/scihub_analysis/habr/img/weekplot_Moscow.png" />
На графике видно, что учёные стараются жить по обычному расписанию: утром приходят на работу, вечером уходят. Правда, многие продолжают работать часов до двух ночи, а также по выходным. Если посмотреть на активность по дням недели - видно, что в субботу читатели научных журналов скорее отдыхают, а в воскресенье уже потихоньку возвращаются к работе.
</spoiler>

Стоит отметить, что вся Россия живёт примерно так же. Разве что в Новосибирске и Казани (в отличие от Москвы и Питера) исследователи стараются по ночам спать, и большую часть рабочей активности концентрируют днём.<spoiler><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/weekplot_Moscow-Novosib.png" /></spoiler> Возможно, что этот эффект полностью пропадёт, если очистить данные московских скачиваний от ботов, которые повышают фоновый уровень.

А кто живёт не так? Да все! Давайте сравним Россию, например, с Францией. Видите, <spoiler title="что поменялось?"><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/dayplot_Russia-France.png" />
Можно предполжить, что французы более-менее синхронно ходят на обеденный перерыв в промежутке с 12 до 14 (на выходных эффект чуть слабее, но тоже заметен). В Париже провал менее выражен, чем по всей Франции в целом. Германия занимает промежуточное положение между Россией и Францией, "обеденный" провал менее глубокий, чем во Франции. Спать в Европе ложатся раньше, но и на работу выходят более организованно.
</spoiler>

Но в целом, видно, что люди работают с 8/9 до 17/18. Часа в 2-3 ночи (в Европе пораньше) город засыпает <s>и просыпается мафия</s>. Но, конечно же, боты продолжают качать в прежнем темпе. У них нет перерывов на день или ночь.
Можно видеть ещё небольшой горбик в вечернее время - около 21-22 часов. Это родители открывают сайхаб, чтобы почитать детям на ночь научно-фантастические сказки. Возможно и другое альтернативное объяснение: учёный приходит домой, открывает браузер, и у него по-новой загружаются закрытые ранее статьи.
Тут я, кстати, почти серьезно говорю. В логах видно, как некоторые пользователи одновременно открывают пару статей, которые уже читали раньше. Это явно артефакт от перезагрузки браузера. Не факт, что исследователь решил прямо сейчас прочесть статью, но загрузка произошла.

Думаю, что пока что вы неплохо справлялись с угадыванием того, как выглядят графики. Тогда... попробуйте угадать, как выглядит график скачиваний в Колумбии (или в Бразилии и Мексике - там довольно похожая ситуация). <spoiler title="Я сам не справился">
<img src="http://stuff.geo-history.org/scihub_analysis/habr/img/weekplot_Russia-Colombia.png" />
Чтобы был сильнее виден контраст, я нарисовал рядом Колумбию и Россию. Ночь и начало рабочего дня выглядит "как положено". К вечеру же происходит что-то странное. То ли учёные предпочитают работать, когда станет прохладней, то ли на работе сайхаб у многих заблокирован/не требуется, и приходится обращаться к нему из дома. Но факт остаётся фактом, пик скачиваний приходится на поздний вечер. Заметьте ещё, что так происходит не всегда, а только с понедельника по четверг. Вечер пятницы научные сотрудники, вероятно, предпочитают проводить не перед монитором, а в каком-нибудь баре.
</spoiler>

При взгляде на Колумбию складывается впечатление, что основные выходные там в пятницу и субботу, а воскресенье - нормальный рабочий день. В этот момент самое время сообразить, что в некоторых странах понедельник начинается в субботу и пойти читать википедию про <a href="https://en.wikipedia.org/wiki/Workweek_and_weekend">устройство рабочей недели</a> в разных странах. Про Колумбию википедия говорит, что рабочая неделя там такая же как у нас, т.е. продолжается с понедельника по пятницу или субботу... Но жизнь, видимо, устроена не так как принято официально. Предваряя вопросы хочу вас заверить, что, это не ошибка определения дня недели в западном полушарии: в близлежащих США и Кубе рабочая неделя определяется, как и должна, с понедельника по пятницу.

Давайте посмотрим на ещё один график со сдвинутой неделей - Израиль. Как известно, рабочая неделя у них с воскресенья по четверг, а вечером пятницы начинается шаббат. И тут никаких сюрпризов, всё так и происходит.<spoiler><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/weekplot_Russia-Israel.png" /></spoiler>

Какими ещё бывают выходные? Заметно отличается от других стран Индия и, особенно, Куба. В большинстве стран воскресенье учёные начинают возвращаться к работе. В Индии и на Кубе воскресенье - полноценный выходной с очень сильным провалом даже относительно субботы. Судя по тому, как резко кончается рабочий день, дело не столько в лени или в национальных традициях, а в том, что на Кубе просто нет возможностей работать из дома. В Индии картина выглядит иначе - смотрите сами. Я построил отдельно <spoiler title="Кубу с Россией"><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/weekplot_Russia-Cuba.png" /></spoiler> и <spoiler title="Индию с Россией."><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/weekplots/Russia-India.png" /></spoiler>
В стране обычно есть общие тренды, которые распространяются на все города. Но бывает и так, что город имеют свою специфику. Калькутте в Индии, например, <spoiler title="несвойственна воскресная расслабленность."><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/weekplot_India-all-Kolkata.png" /></spoiler>

Что удивительно, во многих странах Африки и Ближнего Востока нет существенной разницы между днями недели. Иран, Ирак, Алжир, Египет. Разница между самым загруженным и самым расслабленным днями недели всего 10-20%. В общем, "трудовое законодательство нарушалось злостно и повсеместно". Это не значит, впрочем, что эти страны похожи. Казалось бы, Иран и Ирак должны быть похожи: две рядом расположенные мусульманские страны, но нет. У одних пик работы утром, у других - вечером. <spoiler><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/weekplot_Iran-Iraq.png" /></spoiler>

Но наверное самый любимый для меня пример - это Китай. Во-первых, там очень много пользователей, поэтому статистика получается очень гладкой. Во-вторых, разные города почти не отличаются, удивительная согласованность для довольно большой страны. Ну и, конечно, Китай совсем не похож на Россию. Я буду рисовать несколько городов на одном графике, так что нам больше подойдёт масштаб одного дня, тем более выходные отличаются от будних дней лишь количественно.
<spoiler> 
	<img src="http://stuff.geo-history.org/scihub_analysis/habr/img/dayplot_China-cities.png" />
В Китае перерывов два. В районе половины первого и половины седьмого. А рабочие пики в 11, 16 и 22. Перерывы очень широкие. Это можно было бы объяснить тем, что все идут обедать в разное время, но! Можно заметить, что начинается перерыв довольно резко - сравните, например со Францией. То есть начинается обед почти одновременно, а вот заканчивается он у всех за разное время.
<img src="http://stuff.geo-history.org/scihub_analysis/habr/img/dayplot_China-France-Germany-SouthKorea.png" />
Если почитать про распорядок дня в Китае, можно узнать про традицию послеобеденного сна; похоже, что это не байка. Откуда берётся второй провал и вечерний пик наверняка кто-нибудь расскажет в комментариях.

По дням недели большинство городов тоже похожи, хотя есть город Динси, в котором картина немного отличается. Работа там смещена на вечер, и выходные не так заметны. Тот факт, что относительно небольшой и ничем не примечательный городок Динси попал на третье место в список самых активных городов Китая, скорее всего свидетельствует о том, что геокодер ошибается. Возможно, там располагается одна из точек фильтрации трафика. Или просто координаты определились некорректно.
<img src="http://stuff.geo-history.org/scihub_analysis/habr/img/weekplot_China-DingxiShi.png" /></spoiler>

<h4>Мор, глад, нашествие ботов и другие напасти</h4>
Вы, должно быть заметили, что я обошёл стороной США, хотя они - один из крупнейших пользователей сайхаба. Так вот, у этого есть веские причины. Дело в том, что большую часть трафика в США создают боты. Как я и говорил, <spoiler title="это невозможно перепутать."><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/weekplot_Russia-US.png" /></spoiler>
Трафик ночью отличается от трафика в самое нагруженное время лишь в два раза. Если мы предположим, что боты добывают статьи с постоянной скоростью, а ночью уровень скачиваний от реальных людей пренебрежимо мал, то мы можем грубо оценить, что чуть больше 70% трафика создаётся ботами. Для сравнения, в России этот показатель около 15% (для Москвы - 20%). На этом месте можно злорадно заметить, что после вычитания 70% скачиваний США со свистом вылетает из тройки лидеров пиратства, уступая своё место Ирану.
Построим недельный график без этого фонового уровня. На нём видно, общие закономерности просматриваются: ночью затишье, резкий рост активности с началом рабочего дня и вечером в районе 22 часов, в субботу работа затихает.<spoiler><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/weekplot_Russia-US-pulldown.png" /></spoiler>

Говорят, что в мегаполисах люди никогда не спят, но посмотрите на разницу между <spoiler title="Москвой и Чикаго!"><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/weekplot_Moscow-Chicago.png" /></spoiler>. В Лос-Анджелесе ситуация даже хуже, чем в Чикаго. В Нью-Йорке чуть-чуть получше, зато ночные провалы приходятся не на 4 утра, а на 19 часов вечера - так, словно эти скачивания пришли из другой временной зоны. Но есть среди американских городов и совершенно приличные. Вот, например, <spoiler title="Бостон против Москвы."><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/weekplots/Moscow-Boston.png" /></spoiler>

Аналогичную ситуацию с ботами мы видим в Лондоне и в канадском Торонто. Можно предположить, что в US и UK кто-то задался целью сохранить весь сайхаб, но не совладал с торрентами на либгене. Где ещё боты ведут себя так нагло? В центральном районе Токио, Chiyoda-ku бот запускается каждые полчаса и с нескольких IP скачивает пачку статей. На графике вы можете видеть идеальную пилу. <spoiler><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/dayplot_Japan-Chiyoda-ku.png" /></spoiler>

Какие ещё бывают аномалии? Я уже упоминал ошибки с геокодированием, пора на них посмотреть. В Канаде обнаружилось два крупных города с названиями Montreal и Montréal, имеющие фактически одинаковые координаты. У обоих довольно чёткие графики скачиваний. Пик скачиваний, правда, у них сдвинут часов на 9-10 друг относительно друга.<spoiler><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/dayplot_Canada-Montreals.png" /></spoiler>
Это выглядит так, будто все пользователи какого-то другого далекого города массово ходят в сайхаб через общий VPN. Или, что более вероятно, их IP были неправильно распознаны.

<h4>Zoom in</h4>
Мы рассмотрели как устроен средний день года. Но неужели летом работа идёт так же как зимой? Оказывается, что нет. К сожалению, в самых интересных местах - за полярным кругом - недостаточно статистики, но есть немало других интересных мест. Для начала мы посмотрим на всю Россию целиком. Можно заметить, что рабочий день летом начинается раньше, <spoiler title="видна прямо дуга."><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/heatmap_Russia_daytime.png" /></spoiler>.
Если посмотреть на этот график в недельном разрезе, эффект будет виден слабее. Зато становится понятно, что этот эффект проявляется только по выходным. В будние дни научные сотрудники расписание соблюдают, а по выходным как проснутся, так и работают.<spoiler><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/heatmap_Russia_weektime60.png" /></spoiler>
Приятно, что режим работы практически непрерывен на протяжении года, без неожиданных всплесков... ну почти без них. Я предполагаю, что основной пик активности ботов пришёлся на летние месяцы. Причём боты работали одновременно в нескольких европейских странах. Посмотрите на то, как расположены яркие полосы в ночное время в Германии и Франции и найдите 10 отличий:
<spoiler title="Франция"><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/heatmap_France_daytime.png" /></spoiler>
<spoiler title="Германия"><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/heatmap_Germany_daytime.png" />Кстати заметьте, что в Германии очень видна сезонность: осенью-зимой наблюдается затишье.</spoiler>

Но эти эпизодические нашествия гуннов на земли Германии совершенно меркнут на фоне <spoiler title="Южной Кореи.">
	
	<img src="http://stuff.geo-history.org/scihub_analysis/habr/img/heatmap_SouthKorea_daytime.png" />
	Что-то мне подсказывает, что в эти недели Южная Корея пыталась выкачать целиком весь IEEE (она была одним из лидеров по скачиваниям инженерных статей наряду с Индией).
</spoiler>

На Сейшельских островах ситуация ещё страньше. Как будто группа учёных приехала туда на полгода, а потом дружно уехала. Или будто бот выключался на ночь. <spoiler><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/heatmap_Seychelles_weektime.png" /></spoiler>


Тепловые карты немного примирили меня с одной мучавшей меня загадкой: почему Иран и Ирак так сильно различаются (у первого пик активности утром, у второго - вечером). Иранский год <spoiler title="выглядит так"><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/heatmap_Iran_daytime.png" /></spoiler>, а Иракский - <spoiler title="вот так."><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/heatmap_Iraq_daytime.png" /></spoiler>
Вечерний пик в Ираке появился за счёт всего одного месяца: в ноябре почему-то иракцы предпочитали работать по вечерам (в Колумбии, например, этот пик проявляется весь год).

Присмотритесь теперь внимательнее у июню месяцу (на примере хоть Ирана, хоть Ирака). Видите, как уменьшается интенсивность работы, особенно поздним вечером? А в ночные июньские часы, наоборот, аж до четырёх утра продолжается работа. Этот необычный месяц ночной работы как раз совпадает по датам с Рамаданом. Во время Рамадана днём есть нельзя, а на голодный желудок работается плохо. Приходится навёрстывать упущенное в тёмное время суток.

Напоследок давайте взглянем на <spoiler title="тепловую карту для Марокко."><img src="http://stuff.geo-history.org/scihub_analysis/habr/img/heatmap_Morocco_daytime.png" /></spoiler>. На первый взгляд она ничем не примечательна, но если присмотреться, можно увидеть недели, слегка сдвинутые относительно предыдущей. Объяснением тому служит перевод часов. В Марокко часы переводятся довольно экзотическим способом - 4 раза за год. Основной часовой пояс у них - UTC, но время переводится на час вперёд с последнего воскресенья марта до начала Рамадана, и по его окончании до последнего воскресенья октября. А на время Рамадана возвращается к UTC. На самом деле, часы возвращаются к UTC на время несколько длиннее, чем Рамадан - почти два месяца (с 21 мая по 2 июля). Мы можем видеть сдвиги и на 21 мая, и на 2 июля, и на последнем воскресенье марта. А последнее воскресенье октября как раз было последним днём октябрьской дыры в логах - так что этих данных у нас нет.

<h4>Уцелевшим посвящается</h4>
Я надеюсь, что мне удалось передать хотя бы небольшую часть того удивления и восхищения многообразием мира, которую я испытал, проверяя страну за страной и придумывая всё новые способы смотреть на данные. Удивительно, сколько всего можно узнать из простого лога популярного сайта.
В заключение хочется напомнить, что опасно делать скоропалительные выводы. Когда я ещё не смотрел на тепловые карты, а лишь считал "центр масс" дня и смотрел на провал в июне, я был уверен, что в Иране работа в июне начинается пораньше, потому что погода располагает. Потом понял, что резкий провал - это не погода и сообразил про Рамадан. Но всё ещё считал, что народ просто встаёт пораньше из-за какой-нибудь утренней молитвы. О том, что смещение центра дня происходит не из-за работы рано утром, а очень поздней ночью - после нуля - я догадался сильно не сразу. И кто знает сколько ещё деталей я выпустил из виду.

Сливки сняты, но целая чашка вкусного кофе у вас в руках. Ведь мы даже не пытались смотреть на то, какие статьи пользователи читают. А это богатейшее поле для исследований, ведь каждый пользователь (если он человек) читает статьи в довольно узком диапазоне тем - а значит это готовый датасет для тренировки машинки, определяющей семантическую похожесть статей. Если совсем фантазировать, то это ещё и инструмент промышленного шпионажа: вы можете посмотреть, что читали ваши конкуренты... в прошлом году. Можно ещё смотреть, в каких областях исследователи читают классику, а где только статьи последнего года. Как соотносятся скачивания открытых и закрытых статей в журналах гибридного доступа. Как на влияет наличие препринта на вероятность того, что статью пойдут скачивать на сайхаб.

Впрочем, и без анализа статей есть прорва неисследованных вопросов. Например, можно расклассифицировать IP на дневные и ночные. А также на регулярно и нерегулярно используемые (в НИИ ip-адреса многих лабораторий общие, а значит каждый рабочий день кто-нибудь да использует сайхаб). Мы можем изучать, работают ли пользователи с одного ноутбука дома и на работе или у них принято использовать рабочие компьютеры. А может быть вы хотите проверить, видны ли на графиках дедлайны грантовых заявок? Или может быть вам удастся обнаружить корреляцию пика рабочего дня с географической широтой или, может, с погодой в день скачивания?
Мы можем пытаться понять, что из себя представляют боты: качают они случайные статьи или целые журналы? А может некоторые пользователи с аномальной активностью это и вовсе телеграм-боты, которые являются шлюзом для множества реальных пользователей. Да хотя бы посмотреть на карту активности живых пользователей, очищенную от посторонней активности - уже было бы здорово. 

Все данные открыты - дерзайте! Чтобы вам было проще подступиться, я выкладываю подготовительные скрипты, jupyter-блокнот и небольшой набор обработанных данных:
<ul>
	<li>Таблицы числа скачиваний для усредненной неделю - для каждого города.</li>
	<li>Данные для тепловых карт в нескольких разрешениях - для каждой страны.</li>
</ul>
Если вам хочется посмотреть, как устроена работа в вашей любимой стране, вы можете самостоятельно построить эти картинки (да ещё и интерактивные) в пару кликов.

TODO Добавить архив

Да здравствует sci-hub, и хвала открытым данным!


hubs: Открытые данные, Визуализация данных, Веб-аналитика, IT-эмиграция, Data Mining
tags: sci-hub, open data, data mining, logs, lifestyle, data visualization